{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold text-dark mb-1" style="letter-spacing: 0.5px;">资源检索库</h4>
        <p class="text-muted small mb-0">收录全网优质高数视频，学习快人一步</p>
    </div>

    <div class="d-flex bg-white p-1 rounded-pill shadow-sm border">
        <button type="button" class="btn btn-sort rounded-pill active px-4 py-1 small fw-bold" onclick="changeSort('dry_goods', this)">
            收藏率（每千次播放收藏）
        </button>
        <button type="button" class="btn btn-sort rounded-pill px-4 py-1 small fw-bold" onclick="changeSort('views', this)">
            播放量
        </button>
        <button type="button" class="btn btn-sort rounded-pill px-4 py-1 small fw-bold" onclick="changeSort('new', this)">
            最新发布
        </button>
    </div>
</div>

<!-- 筛选区域 (保持不变，省略部分代码以节省篇幅，直接复制下面的完整代码) -->
<div class="card shadow-sm mb-4 border-0 rounded-4 bg-white">
    <div class="card-body py-3 px-4">
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3" id="category-container">
            <span class="fw-bold text-secondary small me-2">分类</span>
            <a href="javascript:void(0)" class="cat-label active" onclick="filterCat('all', this)">全部</a>
            <span class="spinner-border spinner-border-sm text-secondary ms-2" id="cat-loading"></span>
        </div>
        <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="fw-bold text-secondary small me-2">热词</span>
            <div id="tag-list" class="d-flex flex-wrap gap-2">
                <span class="spinner-border spinner-border-sm text-secondary"></span>
            </div>
        </div>
    </div>
</div>

<div class="row g-4" id="video-grid">
    <div class="col-12 text-center mt-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 text-muted">正在从数据库检索资源...</p>
    </div>
</div>

<div class="d-flex justify-content-center align-items-center mt-5 mb-5">
    <ul class="pagination custom-pagination mb-0" id="pagination"></ul>
</div>

{% endblock %}

{% block scripts %}
<script>
    let state = { sort: 'dry_goods', category: 'all', page: 1, q: '', totalPages: 1 };

    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const q = urlParams.get('q');
        if (q) { state.q = q; $('#global-search-input').val(q); }
        fetchVideos();
        loadHotTags();
        loadCategories();
    });

    // 记录历史的函数 (调用 profile.html 中定义的全局逻辑，或者单独写)
    function logHistory(bvid) {
        $.ajax({
            url: '/api/log_history',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({bvid: bvid}),
            success: function() { console.log('Logged'); }
        });
    }

    function loadCategories() {
        $.get('/api/stats', function(res) {
            $('#cat-loading').remove();
            let container = $('#category-container');
            if (res.chart_tags && res.chart_tags.length > 0) {
                res.chart_tags.forEach(cat => {
                    if (cat) {
                        let html = `<a href="javascript:void(0)" class="cat-label" onclick="filterCat('${cat}', this)">${cat}</a>`;
                        container.append(html);
                    }
                });
            }
        });
    }

    function fetchVideos() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        $('#video-grid').html('<div class="col-12 text-center mt-5"><div class="spinner-border text-primary"></div></div>');

        $.get('/api/videos', state, function(res) {
            state.totalPages = res.pages;
            renderList(res.videos);
            renderPagination(res.total, res.pages, res.current_page);

            // ✅ 激活 Tooltip
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    }

    function renderList(videos) {
        if (!videos || videos.length === 0) {
            $('#video-grid').html('<div class="col-12 text-center py-5"><h5 class="text-muted">暂无数据</h5></div>');
            $('#pagination').empty();
            return;
        }

        let html = '';
        videos.forEach(v => {
            let viewStr = v.view > 10000 ? (v.view/10000).toFixed(1)+'w' : v.view;
            let picUrl = v.pic || 'https://placehold.co/300x180/eee/999?text=No+Image';

            html += `
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 border-0 shadow-sm hover-float rounded-3 overflow-hidden">
                    <a href="${v.link}" target="_blank" class="position-relative d-block" onclick="logHistory('${v.bvid}')">
                        <img src="${picUrl}" class="card-img-top" style="height:160px; object-fit:cover; width: 100%;" referrerpolicy="no-referrer">
                        <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 m-2 rounded-1 font-monospace" style="font-size:0.75rem;">${v.tag || '视频'}</span>
                    </a>
                    <div class="card-body p-3 d-flex flex-column">
                        <h6 class="card-title fw-bold text-dark mb-2 line-clamp-2" title="${v.title}" style="line-height: 1.4;">
                            <a href="${v.link}" target="_blank" class="text-dark text-decoration-none hover-link" onclick="logHistory('${v.bvid}')">${v.title}</a>
                        </h6>
                        <div class="small text-muted mb-3"><i class="fas fa-user-circle me-1"></i> ${v.up}</div>
                        <div class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top">
                            <span class="text-secondary small"><i class="fas fa-play-circle me-1"></i>${viewStr}</span>
                            <!-- ✅ Tooltip 提示 -->
                            <div class="d-flex align-items-center text-danger small fw-bold"
                                 data-bs-toggle="tooltip" data-bs-placement="top" title="收藏率 = (收藏数/播放量)*1000，数值越高代表同等播放下更受青睐">
                                <i class="fas fa-fire me-1"></i> ${v.score}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        $('#video-grid').html(html);
    }

    function renderPagination(total, pages, current) {
        if (pages <= 1) { $('#pagination').html(''); return; }
        let html = '';
        let prevDisabled = current === 1 ? 'disabled' : '';
        html += `<li class="page-item ${prevDisabled}"><button class="page-link long-btn" onclick="changePage(${current - 1})">上一页</button></li>`;
        const makeBtn = (pageNum) => {
            let activeClass = pageNum === current ? 'active' : '';
            return `<li class="page-item ${activeClass}"><button class="page-link" onclick="changePage(${pageNum})">${pageNum}</button></li>`;
        };
        const makeDots = () => '<li class="page-item disabled"><span class="page-link border-0">...</span></li>';
        html += makeBtn(1);
        if (current > 4) html += makeDots();
        let start = Math.max(2, current - 2);
        let end = Math.min(pages - 1, current + 2);
        for (let i = start; i <= end; i++) html += makeBtn(i);
        if (current < pages - 3) html += makeDots();
        if (pages > 1) html += makeBtn(pages);
        let nextDisabled = current === pages ? 'disabled' : '';
        html += `<li class="page-item ${nextDisabled}"><button class="page-link long-btn" onclick="changePage(${current + 1})">下一页</button></li>`;
        $('#pagination').html(html);
    }

    // ✅ 优化后的加载热词函数
    function loadHotTags() {
        $.get('/api/hot_tags', function(tags) {
            let html = '';

            // 1. 数量限制：只取前 10 个，防止占满屏幕
            let displayTags = tags.slice(0, 10);

            displayTags.forEach(tag => {
                // 2. 样式优化：增加 text-truncate 和 max-width 防止单个标签过长
                // title属性让鼠标悬停时能看到完整文字
                html += `
                <button class="btn btn-sm btn-light text-dark border rounded-3 hover-tag transition-all text-truncate"
                        style="max-width: 120px;"
                        title="${tag}"
                        onclick="searchTag('${tag}')">
                    ${tag}
                </button>`;
            });
            $('#tag-list').html(html);
        });
    }

    function changeSort(sortType, btn) {
        state.sort = sortType;
        state.page = 1;
        $('.btn-sort').removeClass('active');
        $(btn).addClass('active');
        fetchVideos();
    }

    function filterCat(cat, btn) {
        state.category = cat;
        state.page = 1;
        $('.cat-label').removeClass('active');
        $(btn).addClass('active');
        fetchVideos();
    }

    function changePage(page) {
        if(page < 1 || page > state.totalPages) return;
        state.page = page;
        fetchVideos();
    }

    function clearSearch() {
        state.q = '';
        $('#global-search-input').val('');
        window.history.replaceState({}, document.title, "/resources");
        fetchVideos();
    }

    function searchTag(tag) {
        state.q = tag;
        state.page = 1;
        $('#global-search-input').val(tag);
        fetchVideos();
    }
</script>

<style>
    .btn-sort { border: none; background: transparent; color: #666; transition: all 0.2s; }
    .btn-sort:hover { color: #00A1D6; background-color: rgba(0, 161, 214, 0.1); }
    .btn-sort.active { background-color: #00A1D6; color: white; box-shadow: 0 2px 6px rgba(0, 161, 214, 0.3); }
    .custom-pagination { gap: 6px; }
    .custom-pagination .page-link { color: #333; border: 1px solid #ddd; border-radius: 6px; margin: 0; min-width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-weight: 500; transition: all 0.2s; }
    .custom-pagination .page-link.long-btn { width: auto; padding: 0 12px; }
    .custom-pagination .page-link:hover:not(.disabled) { border-color: #00A1D6; color: #00A1D6; background-color: #fff; z-index: 2; }
    .custom-pagination .page-item.active .page-link { background-color: #00A1D6; border-color: #00A1D6; color: white; z-index: 3; }
    .custom-pagination .page-item.disabled .page-link { color: #ccc; background-color: #f9f9f9; border-color: #eee; }
    .cat-label { padding: 6px 16px; border-radius: 6px; color: #555; text-decoration: none; font-size: 0.9rem; transition: all 0.2s; }
    .cat-label:hover { color: #00A1D6; background-color: rgba(0, 161, 214, 0.05); }
    .cat-label.active { color: #fff !important; background-color: var(--bili-pink) !important; font-weight: bold; box-shadow: 0 4px 10px rgba(251, 114, 153, 0.3); }
    .hover-float { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .hover-float:hover { transform: translateY(-8px); box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important; }
    .hover-link:hover { color: #00A1D6 !important; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.8em; }
    .hover-tag:hover { border-color: #00A1D6 !important; color: #00A1D6 !important; }
    .btn:focus, .page-link:focus { box-shadow: none; }
</style>
{% endblock %}