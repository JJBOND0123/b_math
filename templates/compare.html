{% extends "base.html" %}

{% block content %}
<style>
    /* 局部样式覆盖，配合 style.css */
    .compare-header {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* 极简的 VS 分隔符 */
    .vs-divider {
        color: #ddd;
        font-size: 1.5rem;
        font-weight: 300;
        position: relative;
        top: 5px;
    }

    /* 优化下拉框样式 */
    .custom-select {
        border: 2px solid transparent;
        background-color: var(--bg-gray);
        border-radius: 8px;
        font-weight: 600;
        color: #333;
        height: 50px;
        transition: all 0.3s;
        text-align: center;
        text-align-last: center;
    }

    /* 选中时的边框色，对应 B 站蓝粉 */
    .select-blue:focus, .select-blue:hover {
        background-color: #fff;
        border-color: var(--tech-blue);
        box-shadow: 0 0 0 4px rgba(0, 161, 214, 0.1);
    }
    .select-pink:focus, .select-pink:hover {
        background-color: #fff;
        border-color: var(--bili-pink);
        box-shadow: 0 0 0 4px rgba(251, 114, 153, 0.1);
    }

    /* 图表卡片标题 */
    .card-header-custom {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .radar-title {
        font-size: 1.15rem;
        letter-spacing: 1px;
    }

    /* 名字标签 */
    .badge-name {
        font-size: 0.9rem;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: normal;
    }
    .badge-blue { background: rgba(0, 161, 214, 0.1); color: var(--tech-blue); }
    .badge-pink { background: rgba(251, 114, 153, 0.1); color: var(--bili-pink); }

</style>

<!-- 顶部选择栏：极简、扁平 -->
<div class="compare-header mb-4">
    <div class="row align-items-center">
        <!-- 蓝方 -->
        <div class="col-md-5">
            <div class="d-flex align-items-center">
                <div class="me-3 d-none d-md-block text-end" style="width: 40px;">
                    <i class="fas fa-user-astronaut fa-2x" style="color: var(--tech-blue);"></i>
                </div>
                <select id="select-up1" class="form-select custom-select select-blue" onchange="updateNames()">
                    {% for up in up_list %}<option value="{{up}}">{{up}}</option>{% endfor %}
                </select>
                <div class="ms-3 d-none d-md-block text-start" style="width: 40px;">
                    <i class="fas fa-robot fa-2x" style="color: #6c757d;"></i>
                </div>
            </div>
        </div>

        <!-- 极简分隔 -->
        <div class="col-md-2 text-center">
            <i class="fas fa-exchange-alt text-muted opacity-50" style="font-size: 1.2rem;"></i>
        </div>

        <!-- 红方 -->
        <div class="col-md-5">
            <div class="d-flex align-items-center justify-content-end">
                <div class="me-3 d-none d-md-block text-end" style="width: 40px;">
                    <i class="fas fa-user-ninja fa-2x" style="color: var(--bili-pink);"></i>
                </div>
                <select id="select-up2" class="form-select custom-select select-pink" onchange="updateNames()">
                    {% for up in up_list %}<option value="{{up}}" {% if loop.index==2 %}selected{% endif %}>{{up}}</option>{% endfor %}
                </select>
                <div class="ms-3 d-none d-md-block text-start" style="width: 40px;">
                    <i class="fas fa-robot fa-2x" style="color: #6c757d;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 居中分析按钮 -->
    <div class="text-center mt-3">
        <button class="btn btn-dark rounded-pill px-5 shadow-sm hover-scale" onclick="startPK()">
            <i class="fas fa-chart-line me-2"></i>生成对比报告
        </button>
    </div>
</div>

<!-- 数据展示区：左右 1:1 均分，让图表更大气 -->
<div class="row g-4">

    <!-- 左侧：五维雷达图 -->
    <div class="col-lg-6">
        <div class="card h-100 p-4 shadow-sm">
            <div class="text-center fw-bold radar-title mb-3"><i class="fas fa-radar-chart me-2 text-muted"></i>综合能力模型</div>
            <div id="radarChart" style="height: 500px; width: 100%;"></div>
        </div>
    </div>

    <!-- 右侧：词云画像 (上下布局) -->
    <div class="col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body p-0">
                <!-- 上半部分：蓝方词云 -->
                <div class="p-3 border-bottom" style="height: 50%;">
                    <div class="d-flex justify-content-start align-items-center mb-2">
                        <span class="badge-name badge-blue fw-bold" id="cloud-name1">UP1</span>
                    </div>
                    <div id="wordCloud1" style="height: 220px;"></div>
                </div>

                <!-- 下半部分：红方词云 -->
                <div class="p-3" style="height: 50%;">
                    <div class="d-flex justify-content-start align-items-center mb-2">
                        <span class="badge-name badge-pink fw-bold" id="cloud-name2">UP2</span>
                    </div>
                    <div id="wordCloud2" style="height: 220px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/echarts-wordcloud.min.js') }}"></script>
<script>
let radarChart, wc1, wc2;
const COLOR_BLUE = '#00A1D6'; // var(--tech-blue)
const COLOR_PINK = '#FB7299'; // var(--bili-pink)

// 页面加载或下拉框变化时，更新页面上的文字标签
function updateNames() {
    const n1 = $('#select-up1').val();
    const n2 = $('#select-up2').val();
    $('#cloud-name1').text(n1);
    $('#cloud-name2').text(n2);
}

function startPK() {
    const up1 = $('#select-up1').val();
    const up2 = $('#select-up2').val();

    // 确保标签同步
    updateNames();

    // Loading 动画颜色区分
    if(radarChart) radarChart.showLoading({color: '#333'});
    if(wc1) wc1.showLoading({color: COLOR_BLUE});
    if(wc2) wc2.showLoading({color: COLOR_PINK});

    $.get('/api/compare_data', {up1: up1, up2: up2}, function(res) {
        renderRadar(up1, up2, res.up1_stats, res.up2_stats);
        renderWordCloud('wordCloud1', res.up1_words, COLOR_BLUE);
        renderWordCloud('wordCloud2', res.up2_words, COLOR_PINK);
    });
}

function renderRadar(name1, name2, data1, data2) {
    if (!radarChart) radarChart = echarts.init(document.getElementById('radarChart'));
    radarChart.hideLoading();

    const option = {
        color: [COLOR_BLUE, COLOR_PINK],
        tooltip: { trigger: 'item' },
        legend: {
            bottom: '0%',
            icon: 'circle',
            data: [name1, name2] // 动态图例
        },
        radar: {
            // 调大半径，让图看起来更“大方”
            radius: '70%',
            center: ['50%', '50%'],
            indicator: [
                { name: '产出积累', max: 100 },
                { name: '流量层级', max: 100 },
                { name: '内容质量', max: 100 },
                { name: '粉丝粘性', max: 100 },
                { name: '硬核指数', max: 100 }
            ],
            axisName: {
                color: '#666',
                fontWeight: 'bold',
                fontSize: 14 // 字体改大
            },
            splitArea: {
                show: true,
                areaStyle: {
                    color: ['#fff', '#f8f9fa'] // 极淡的灰白交替
                }
            }
        },
        series: [{
            type: 'radar',
            symbol: 'circle',
            symbolSize: 8,
            lineStyle: { width: 3 },
            data: [
                {
                    value: data1,
                    name: name1, // 对应 Legend
                    areaStyle: { opacity: 0.25 }
                },
                {
                    value: data2,
                    name: name2, // 对应 Legend
                    areaStyle: { opacity: 0.25 }
                }
            ]
        }]
    };
    radarChart.setOption(option);
}

function renderWordCloud(elemId, data, themeColor) {
    const chart = echarts.init(document.getElementById(elemId));
    // 存储实例引用
    if (elemId === 'wordCloud1') wc1 = chart; else wc2 = chart;
    chart.hideLoading();

    const option = {
        tooltip: { show: true },
        series: [{
            type: 'wordCloud',
            shape: 'circle',
            left: 'center', top: 'center',
            width: '90%', height: '90%',
            sizeRange: [14, 40], // 稍微调大最小字体
            rotationRange: [-30, 30],
            gridSize: 8,
            layoutAnimation: true,
            textStyle: {
                fontFamily: 'sans-serif',
                fontWeight: 'bold',
                color: function () {
                    // 同色系生成逻辑
                    if (themeColor === COLOR_BLUE) {
                        return `rgba(0, ${130 + Math.random() * 100}, ${200 + Math.random() * 55}, ${Math.random() * 0.6 + 0.4})`;
                    } else {
                        return `rgba(251, ${50 + Math.random() * 100}, ${100 + Math.random() * 100}, ${Math.random() * 0.6 + 0.4})`;
                    }
                }
            },
            emphasis: {
                focus: 'self',
                textStyle: { textShadowBlur: 8, textShadowColor: '#ddd' }
            },
            data: data
        }]
    };
    chart.setOption(option);
}

window.addEventListener('resize', function() {
    if(radarChart) radarChart.resize();
    if(wc1) wc1.resize();
    if(wc2) wc2.resize();
});

$(document).ready(function() {
    updateNames(); // 初始化名字
    startPK();     // 初始化图表
});
</script>
{% endblock %}