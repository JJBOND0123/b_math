{% extends "base.html" %}

{% block content %}
<script src="{{ url_for('static', filename='js/echarts-wordcloud.min.js') }}"></script>

<div class="container-fluid px-3">

    <!-- 1. 顶部控制台 -->
    <div class="bili-panel pk-console">
        <div class="fighter-zone zone-blue">
            <div class="zone-label">蓝方选手</div>
            <div class="bili-select-wrapper" id="select-wrapper-1">
                <div class="bili-select-trigger" onclick="toggleSelect('select-wrapper-1')">
                    <span id="text-up1">选择 UP 主</span> <i class="fas fa-chevron-down"></i>
                </div>
                <div class="bili-options">
                    {% for up in up_list %}
                    <div class="bili-option" onclick="chooseUp(1, '{{up}}')">{{up}}</div>
                    {% endfor %}
                </div>
                <select id="val-up1" style="display:none;">{% for up in up_list %}<option value="{{up}}">{{up}}</option>{% endfor %}</select>
            </div>
        </div>

        <div class="vs-axis">
            <div class="vs-text">VS</div>
            <button class="btn-start" onclick="startPK()">开始对比</button>
        </div>

        <div class="fighter-zone zone-pink">
            <div class="zone-label">红方选手</div>
            <div class="bili-select-wrapper" id="select-wrapper-2">
                <div class="bili-select-trigger" onclick="toggleSelect('select-wrapper-2')">
                    <span id="text-up2">选择 UP 主</span> <i class="fas fa-chevron-down"></i>
                </div>
                <div class="bili-options">
                    {% for up in up_list %}
                    <div class="bili-option" onclick="chooseUp(2, '{{up}}')">{{up}}</div>
                    {% endfor %}
                </div>
                <select id="val-up2" style="display:none;">{% for up in up_list %}<option value="{{up}}" {% if loop.index==2 %}selected{% endif %}>{{up}}</option>{% endfor %}</select>
            </div>
        </div>
    </div>

    <!-- 2. 图表区 -->
    <div class="row g-3">
        <!-- 左侧：雷达图 -->
        <div class="col-lg-6">
            <div class="bili-panel">
                <div class="panel-header">
                    <div class="panel-title">五维能力模型</div>
                    <span class="panel-subtitle">近期数据综合分析</span>
                </div>
                <div id="radarChart" style="height: 300px; width: 100%;"></div>
                <div class="mt-2">
                    <table class="data-table">
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 右侧：词云图 -->
        <div class="col-lg-6">
            <div class="bili-panel">
                <div class="panel-header">
                    <div class="panel-title">内容关键词分布</div>
                    <span class="panel-subtitle">语义分析</span>
                </div>
                <!-- Flex:1 自动填满 -->
                <div id="keywordCloud" style="flex: 1; width: 100%; min-height: 400px;"></div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSelect(id) {
        $('.bili-select-wrapper').not('#'+id).removeClass('active');
        $('#'+id).toggleClass('active');
    }
    function chooseUp(index, name) {
        $('#text-up'+index).text(name);
        $('#val-up'+index).val(name);
        $('#select-wrapper-'+index).removeClass('active');
    }
    $(document).click(function(e) {
        if(!$(e.target).closest('.bili-select-wrapper').length) {
            $('.bili-select-wrapper').removeClass('active');
        }
    });

    let radarChart, keywordChart;
    const METRICS = [
        {key: 'view',  label: '播放量',     formula: 'view_count 总和'},
        {key: 'rate',  label: '收藏率',     formula: 'favorite_count ÷ view_count'},
        {key: 'inter', label: '互动均值',   formula: '(弹幕数 + 评论数) ÷ 视频数 ÷ 2'},
        {key: 'depth', label: '收藏/小时',  formula: '收藏数 ÷ 视频总时长(小时)'},
        {key: 'active',label: '视频/周',    formula: '视频数 ÷ 发布天数 × 7'}
    ];

    $(document).ready(function() {
        let v1 = $('#val-up1').val();
        let v2 = $('#val-up2').val();
        $('#text-up1').text(v1);
        $('#text-up2').text(v2);
        startPK();
    });

    function startPK() {
        const up1 = $('#val-up1').val();
        const up2 = $('#val-up2').val();

        if (!radarChart) radarChart = echarts.init(document.getElementById('radarChart'));
        if (!keywordChart) keywordChart = echarts.init(document.getElementById('keywordCloud'));

        radarChart.showLoading({color: '#00AEEC', maskColor: 'rgba(255,255,255,0.8)'});
        keywordChart.showLoading({color: '#00AEEC', maskColor: 'rgba(255,255,255,0.8)'});

        $.get('/api/compare_data', {up1: up1, up2: up2}, function(res) {
            radarChart.hideLoading();
            keywordChart.hideLoading();

            renderRadar(up1, up2, res.up1.radar, res.up2.radar);
            renderCloud(up1, up2, res.up1.words, res.up2.words);
            renderTable(res.up1.metrics, res.up2.metrics);

            // 只要 resize 即可，不需要 setTimeout 做动画
            radarChart.resize();
            keywordChart.resize();
        });
    }

    function renderRadar(name1, name2, data1, data2) {
        const option = {
            color: ['#00AEEC', '#FB7299'],
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    // params[0] 是当前指针所在的维度
                    const p = params[0] || {};
                    const indicatorName = (p.indicator && p.indicator.name) || p.axisValue || p.name || '';
                    const idx = METRICS.findIndex(m => m.label === indicatorName);
                    const metric = METRICS[idx >= 0 ? idx : 0];
                    const val = Array.isArray(p.value) ? (p.value[idx >= 0 ? idx : 0] || 0) : (p.value || 0);
                    return `<div><strong>${metric.label}</strong><br/>得分：${Number(val).toFixed(1)} / 100<br/><span style="color:#999;">公式：${metric.formula}</span></div>`;
                },
                confine: true
            },
            legend: { bottom: 0, icon: 'circle', itemGap: 20 },
            radar: {
                radius: '70%',
                center: ['50%', '50%'],
                indicator: METRICS.map(m => ({ name: m.label, max: 100 })),
                axisName: { color: '#666', fontSize: 12, fontWeight: 'bold' },
                splitArea: { show: true, areaStyle: { color: ['#fff', '#fcfcfc'] } },
                axisLine: { lineStyle: { color: '#eee' } }
            },
            series: [{
                type: 'radar',
                symbolSize: 6,
                lineStyle: { width: 2 },
                areaStyle: { opacity: 0.2 },
                data: [
                    { value: data1, name: name1 },
                    { value: data2, name: name2 }
                ]
            }]
        };
        // 直接渲染，不搞花里胡哨的
        radarChart.setOption(option);
    }

    function renderCloud(n1, n2, w1, w2) {
        let data = [];
        if(w1) data = data.concat(w1.map(w => ({ name: w.name, value: w.value, textStyle: { color: '#00AEEC' } })));
        if(w2) data = data.concat(w2.map(w => ({ name: w.name, value: w.value, textStyle: { color: '#FB7299' } })));

        if(data.length===0) data = [{name:'暂无数据', value:100}];

        keywordChart.setOption({
            tooltip: { show: true },
            series: [{
                type: 'wordCloud',

                // ✅ 1. 回归经典圆形
                shape: 'circle',

                // 2. 居中显示
                left: 'center', top: 'center',
                width: '100%', height: '100%',
                right: null, bottom: null,

                // ✅ 3. 回归标准字号 (不再为了撑满而变大)
                sizeRange: [12, 42],

                // ✅ 4. 回归经典旋转角度 (轻微倾斜，更有设计感)
                rotationRange: [-30, 30],
                rotationStep: 1,

                // ✅ 5. 回归标准间距 (有呼吸感)
                gridSize: 10,

                drawOutOfBound: false,
                textStyle: { fontFamily: 'sans-serif', fontWeight: 'bold' },
                data: data
            }]
        });
    }


    function renderTable(m1, m2) {
        const tbody = $('#table-body');
        tbody.empty();
        METRICS.forEach(m => {
            let v1 = formatVal(m1[m.key]);
            let v2 = formatVal(m2[m.key]);
            tbody.append(`
                <tr class="data-row">
                    <td class="data-cell cell-label">
                        <div class="metric-label" title="公式：${m.formula}">${m.label}</div>
                    </td>
                    <td class="data-cell cell-val-blue">${v1}</td>
                    <td class="data-cell cell-val-pink">${v2}</td>
                </tr>
            `);
        });
    }

    function formatVal(item) {
        if(!item) return '-';
        let v = item.value;
        let u = item.unit || '';
        if(typeof v !== 'number') return u ? `${v}${u}` : v;
        if(u === '%') return v.toFixed(1) + '%';

        let base = v;
        let unitLabel = u;
        if(Math.abs(v) >= 10000) {
            base = v / 10000;
            unitLabel = `万${u}`;
        }
        const needsDecimal = base % 1 !== 0;
        const numStr = needsDecimal ? base.toFixed(1) : base;
        return unitLabel ? `${numStr}${unitLabel}` : numStr;
    }

    window.addEventListener('resize', function() {
        radarChart && radarChart.resize();
        keywordChart && keywordChart.resize();
    });
</script>
{% endblock %}
