{% extends "base.html" %}

{% block content %}
<style>
    :root {
        --bili-pink: #FB7299;
        --bili-blue: #00AEEC;
        --bili-text: #18191C;
        --bili-gray: #9499A0;
        --bili-border: #E3E5E7;
    }

    /* 1. 顶部 Tab */
    .nav-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid var(--bili-border); margin-bottom: 24px;
    }
    .bili-tabs { display: flex; gap: 30px; }
    .bili-tab {
        padding: 14px 0; font-size: 16px; color: var(--bili-text); cursor: pointer;
        position: relative; font-weight: 500; transition: 0.2s;
    }
    .bili-tab:hover { color: var(--bili-blue); }
    .bili-tab.active { color: var(--bili-blue); font-weight: 700; }
    .bili-tab.active::after {
        content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%);
        width: 24px; height: 3px; background: var(--bili-blue); border-radius: 2px;
    }

    .btn-refresh {
        font-size: 13px; color: var(--bili-gray); background: transparent; border: 1px solid var(--bili-border);
        padding: 6px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px;
    }
    .btn-refresh:hover { border-color: var(--bili-blue); color: var(--bili-blue); }
    .btn-refresh i { transition: transform 0.4s; }
    .btn-refresh:hover i { transform: rotate(180deg); }

    /* 2. 视频卡片 */
    .video-card {
        background: #fff; border-radius: 6px; overflow: hidden; transition: all 0.3s;
        /* 轻微边框 */
        border: 1px solid #F1F2F3;
        display: flex; flex-direction: column; height: 100%;
    }
    .video-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

    .card-cover { width: 100%; aspect-ratio: 16/10; background: #f6f7f8; position: relative; overflow: hidden; }
    .card-cover img { width: 100%; height: 100%; object-fit: cover; }
    .duration { position: absolute; bottom: 6px; right: 6px; background: rgba(0,0,0,0.6); color: #fff; padding: 0 4px; border-radius: 2px; font-size: 12px; }

    .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .card-title {
        font-size: 15px; color: var(--bili-text); line-height: 22px; height: 44px;
        overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        margin-bottom: 8px; text-decoration: none; font-weight: 500; transition: 0.2s;
    }
    .card-title:hover { color: var(--bili-blue); }

    .meta-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--bili-gray); margin-bottom: 12px; }
    .up-link { display: flex; align-items: center; gap: 6px; text-decoration: none; color: var(--bili-gray); }
    .up-link:hover { color: var(--bili-blue); }
    .up-avatar { width: 18px; height: 18px; border-radius: 50%; }

    .score-box { color: #FF6699; font-weight: 700; display: flex; align-items: center; gap: 3px; }
    .score-box i { font-size: 14px; }

    /* 底部按钮 */
    .action-bar { margin-top: auto; display: flex; gap: 8px; }
    .btn-mini {
        flex: 1; font-size: 12px; padding: 6px 0; border-radius: 4px; background: #F6F7F8;
        color: #61666D; text-align: center; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .btn-mini:hover { background: #E3F5FF; color: var(--bili-blue); }
    .btn-mini.active { background: var(--bili-pink); color: #fff; }

    /* Toast */
    .toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
    .custom-toast {
        background: rgba(0,0,0,0.8); color: #fff; padding: 8px 20px; border-radius: 6px;
        opacity: 0; transform: translateY(-20px); transition: 0.3s; font-size: 14px;
    }
    .custom-toast.show { opacity: 1; transform: translateY(0); }
</style>

<div class="toast-container" id="toastContainer"></div>

<div class="nav-header">
    <div class="bili-tabs">
        <div class="bili-tab active" onclick="switchScene('guess', this)">猜你喜欢</div>
        <div class="bili-tab" onclick="switchScene('exam', this)">期末突击</div>
        <div class="bili-tab" onclick="switchScene('basic', this)">考研基础</div>
        <div class="bili-tab" onclick="switchScene('exercise', this)">习题冲刺</div>
    </div>
    <button class="btn-refresh" id="btn-refresh" onclick="refreshList()">
        <i class="fas fa-sync-alt"></i> 换一换
    </button>
</div>

<div class="row g-3" id="rec-grid"></div>

{% endblock %}

{% block scripts %}
<script>
    let currentScene = 'guess';

    function switchScene(scene, btn) {
        if(currentScene === scene) return;
        currentScene = scene;
        $('.bili-tab').removeClass('active'); $(btn).addClass('active');
        if (scene === 'guess') $('#btn-refresh').show(); else $('#btn-refresh').hide();
        loadRec(scene);
    }

    function refreshList() { loadRec(currentScene); }

    function loadRec(scene) {
        $('#rec-grid').html('<div class="col-12 text-center py-5"><div class="spinner-border text-secondary opacity-25"></div></div>');

        $.get('/api/recommend', {scene: scene}, function(data) {
            if (!data || data.length === 0) {
                $('#rec-grid').html('<div class="col-12 text-center py-5 text-muted">暂无内容</div>');
                return;
            }

            let html = '';
            data.forEach(function(v) {
                let pic = v.pic_url || 'https://placehold.co/320x200/F6F7F8/9499A0?text=Cover';
                let view = formatCount(v.view_count);

                // ⚡️ 接口容错逻辑
                let upFace = v.up_face || `https://placehold.co/50x50/E3E5E7/999?text=${v.up_name.charAt(0)}`;
                let upLink = v.up_mid ? `https://space.bilibili.com/${v.up_mid}` : 'javascript:void(0)';
                let target = v.up_mid ? 'target="_blank"' : '';
                let badge = v.category || formatDuration(v.duration);

                html += `
                <div class="col-md-3 col-sm-6">
                    <div class="video-card">
                        <div class="card-cover">
                            <a href="${v.link}" target="_blank" onclick="logAction('${v.bvid}')">
                                <img src="${pic}" referrerpolicy="no-referrer" onerror="this.src='https://placehold.co/320x200/eee/999?text=Error'">
                            </a>
                            <div class="duration">${badge || 'HD'}</div>
                        </div>
                        <div class="card-body">
                            <a href="${v.link}" target="_blank" class="card-title" title="${v.title}" onclick="logAction('${v.bvid}')">
                                ${v.title}
                            </a>

                            <div class="meta-row">
                                <a href="${upLink}" ${target} class="up-link">
                                    <img src="${upFace}" class="up-avatar" onerror="this.src='https://placehold.co/20x20/eee/999?text=U'">
                                    <span class="text-truncate" style="max-width:70px;">${v.up_name}</span>
                                </a>
                                <div><i class="far fa-play-circle"></i> ${view}</div>
                            </div>

                            <div class="action-bar">
                                <div class="btn-mini" onclick="doAction('${v.bvid}', 'fav', this)">
                                    <i class="far fa-heart"></i> 收藏
                                </div>
                                <div class="btn-mini" onclick="doAction('${v.bvid}', 'todo', this)">
                                    <i class="fas fa-plus"></i> 待办
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            $('#rec-grid').html(html);
        });
    }

    function doAction(bvid, type, btn) {
        let $btn = $(btn);
        let isActive = $btn.hasClass('active');
        let url = isActive ? '/api/remove_action' : '/api/action';

        $.ajax({
            url: url, type: 'POST', contentType: 'application/json', data: JSON.stringify({bvid: bvid, type: type}),
            success: function() {
                if(isActive) { $btn.removeClass('active'); showToast('已取消'); }
                else { $btn.addClass('active'); showToast('操作成功'); }
            }
        });
    }

    function showToast(msg) {
        const toast = $(`<div class="custom-toast"><i class="fas fa-check-circle" style="color:#2AC864; margin-right:5px;"></i> ${msg}</div>`);
        $('#toastContainer').append(toast);
        setTimeout(() => toast.addClass('show'), 10);
        setTimeout(() => { toast.removeClass('show'); setTimeout(() => toast.remove(), 300); }, 2000);
    }

    function logAction(bvid) { logHistory(bvid); }

    $(document).ready(function() { loadRec('guess'); });
</script>
{% endblock %}
