{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
    <div class="col-md-4">
        <div class="card p-4 text-center h-100 shadow-sm border-0">
            <div class="position-relative mx-auto mb-3" style="width: 120px; height: 120px;">
                <img id="profile-avatar" src="" class="rounded-circle shadow-sm border border-3 border-white" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <h4 class="fw-bold" id="user-name">åŠ è½½ä¸­...</h4>
            <p class="text-muted mb-3" id="user-desc">...</p>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="fas fa-camera"></i> ç¼–è¾‘èµ„æ–™ & å¤´åƒ
                </button>
            </div>
        </div>
    </div>
    <!-- å³ä¾§ï¼šæ•°æ®ç»Ÿè®¡ -->
    <div class="col-md-8">
        <div class="card p-4 h-100 shadow-sm border-0">
            <h5 class="mb-4"><i class="fas fa-chart-line text-primary"></i> å­¦ä¹ è®¡åˆ’è¿›åº¦</h5>
            <div class="row text-center g-3 mb-4">
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3">
                        <h3 class="fw-bold text-danger mb-0" id="stat-fav-count">0</h3>
                        <small class="text-muted">æ”¶è—è§†é¢‘</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3">
                        <h3 class="fw-bold text-primary mb-0" id="stat-todo-total">0</h3>
                        <small class="text-muted">å¾…åŠä»»åŠ¡</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3">
                        <h3 class="fw-bold text-success mb-0" id="stat-todo-done">0</h3>
                        <small class="text-muted">å·²å®Œæˆ</small>
                    </div>
                </div>
            </div>
            <div class="mb-2 d-flex justify-content-between fw-bold">
                <span class="small text-muted">å½“å‰å®Œæˆåº¦</span>
                <span id="progress-text" class="text-success small">0%</span>
            </div>
            <div class="progress" style="height: 15px; border-radius: 10px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<!-- é€‰é¡¹å¡å¯¼èˆª -->
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active fw-bold" id="todo-tab" data-bs-toggle="tab" data-bs-target="#todo-pane">
            <i class="fas fa-list-check text-primary"></i> å­¦ä¹ è®¡åˆ’
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" id="fav-tab" data-bs-toggle="tab" data-bs-target="#fav-pane">
            <i class="fas fa-heart text-danger"></i> æˆ‘çš„æ”¶è—
        </button>
    </li>
    <!-- âœ… æ–°å¢å†å²é€‰é¡¹å¡ -->
    <li class="nav-item">
        <button class="nav-link fw-bold" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane">
            <i class="fas fa-history text-secondary"></i> å­¦ä¹ è¶³è¿¹
        </button>
    </li>
</ul>

<!-- é€‰é¡¹å¡å†…å®¹ -->
<div class="tab-content" id="myTabContent">
    <!-- 1. å¾…åŠ -->
    <div class="tab-pane fade show active" id="todo-pane">
        <div class="row g-4" id="todo-grid"></div>
    </div>
    <!-- 2. æ”¶è— -->
    <div class="tab-pane fade" id="fav-pane">
        <div class="row g-4" id="fav-grid"></div>
    </div>
    <!-- 3. å†å² (æ–°å¢) -->
    <div class="tab-pane fade" id="history-pane">
        <div class="row g-4" id="history-grid"></div>
    </div>
</div>

<!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">ä¿®æ”¹ä¸ªäººä¿¡æ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3 text-center">
                        <label for="input-avatar" class="form-label d-block cursor-pointer">
                            <div class="d-inline-block position-relative">
                                <img id="preview-avatar" src="" class="rounded-circle shadow-sm" style="width: 80px; height: 80px; object-fit: cover;">
                                <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-secondary">ä¿®æ”¹</span>
                            </div>
                        </label>
                        <input type="file" class="form-control d-none" id="input-avatar" accept="image/*" onchange="previewImage(this)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ˜µç§°</label>
                        <input type="text" class="form-control" id="input-username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸ªæ€§ç­¾å</label>
                        <textarea class="form-control" id="input-desc" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function loadProfile() {
        $.get('/api/user_profile', function(data) {
            let info = data.user_info;
            let stats = data.todo_stats;

            $('#user-name').text(info.username);
            $('#user-desc').text(info.description);
            $('#profile-avatar').attr('src', info.avatar);
            $('#preview-avatar').attr('src', info.avatar);
            $('#input-username').val(info.username);
            $('#input-desc').val(info.description);

            $('#stat-fav-count').text(data.favorites.length);
            $('#stat-todo-total').text(stats.total);
            $('#stat-todo-done').text(stats.done);

            let percent = stats.total > 0 ? Math.round(stats.done / stats.total * 100) : 0;
            $('#progress-text').text(percent + '%');
            $('#progress-bar').css('width', percent + '%').attr('aria-valuenow', percent);

            renderTodoGrid(data.todos);
            renderFavGrid(data.favorites);
            renderHistoryGrid(data.history); // âœ… æ¸²æŸ“å†å²
        });
    }

    function renderTodoGrid(list) {
        let container = $('#todo-grid');
        if (!list || list.length === 0) { container.html(emptyState('æš‚æ— å¾…åŠä»»åŠ¡')); return; }
        let html = '';
        list.forEach(v => {
            let picUrl = v.pic || 'https://placehold.co/300x180/eee/999?text=No+Image';
            let isDone = v.status === 1;
            let cardClass = isDone ? 'border-success bg-light opacity-75' : '';
            let btnClass = isDone ? 'btn-success' : 'btn-outline-secondary';
            let btnText = isDone ? 'å·²å®Œæˆ' : 'æ ‡è®°å®Œæˆ';
            html += `
            <div class="col-md-3">
                <div class="card h-100 shadow-sm hover-up ${cardClass}">
                    <a href="${v.link}" target="_blank" class="position-relative" onclick="logHistory('${v.bvid}')">
                        <img src="${picUrl}" class="card-img-top" style="height:120px; object-fit:cover;" referrerpolicy="no-referrer">
                        ${isDone ? '<div class="position-absolute top-0 start-0 w-100 h-100 bg-white opacity-50 d-flex align-items-center justify-content-center"><i class="fas fa-check-circle text-success fa-3x"></i></div>' : ''}
                    </a>
                    <div class="card-body p-3">
                        <h6 class="card-title text-truncate mb-2">${v.title}</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm ${btnClass}" onclick="toggleTodo('${v.bvid}')"><i class="fas ${isDone ? 'fa-check' : 'fa-square'}"></i> ${btnText}</button>
                            <button class="btn btn-sm text-muted" onclick="removeAction('${v.bvid}', 'todo')">ç§»é™¤</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        container.html(html);
    }

    function renderFavGrid(list) {
        let container = $('#fav-grid');
        if (!list || list.length === 0) { container.html(emptyState('æš‚æ— æ”¶è—')); return; }
        let html = '';
        list.forEach(v => {
            let picUrl = v.pic || 'https://placehold.co/300x180/eee/999?text=No+Image';
            html += `
            <div class="col-md-3">
                <div class="card h-100 shadow-sm hover-up">
                    <a href="${v.link}" target="_blank" onclick="logHistory('${v.bvid}')">
                        <img src="${picUrl}" class="card-img-top" style="height:120px; object-fit:cover;" referrerpolicy="no-referrer">
                    </a>
                    <div class="card-body p-3">
                        <h6 class="card-title text-truncate">${v.title}</h6>
                        <div class="mt-2 d-flex justify-content-between">
                            <!-- âœ… ä¼˜åŒ–åçš„æ˜¾ç¤ºï¼šæ”¶è—ç‡ï¼ˆæ¯åƒæ’­æ”¾æ”¶è—ï¼‰ -->
                            <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="æ”¶è—ç‡ï¼šåŸºäºæ”¶è—/æ’­æ”¾æ¯”è®¡ç®—">ğŸ”¥ ${v.score}</span>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="removeAction('${v.bvid}', 'fav')">å–æ¶ˆæ”¶è—</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        container.html(html);
    }

    // âœ… æ–°å¢ï¼šæ¸²æŸ“å†å²è®°å½•
    function renderHistoryGrid(list) {
        let container = $('#history-grid');
        if (!list || list.length === 0) { container.html(emptyState('æš‚æ— è§‚çœ‹è®°å½•')); return; }
        let html = '';
        list.forEach(v => {
            let picUrl = v.pic || 'https://placehold.co/300x180/eee/999?text=No+Image';
            html += `
            <div class="col-md-3">
                <div class="card h-100 shadow-sm border-0 hover-up">
                    <a href="${v.link}" target="_blank" onclick="logHistory('${v.bvid}')">
                        <img src="${picUrl}" class="card-img-top" style="height:120px; object-fit:cover; filter: grayscale(30%);" referrerpolicy="no-referrer">
                    </a>
                    <div class="card-body p-3">
                        <h6 class="card-title text-truncate mb-1 text-muted">${v.title}</h6>
                        <small class="text-secondary"><i class="fas fa-clock"></i> ${v.action_time}</small>
                    </div>
                </div>
            </div>`;
        });
        container.html(html);
    }

    function emptyState(msg) {
        return `<div class="col-12 text-center py-5 text-muted"><i class="far fa-folder-open fs-1 mb-2"></i><p>${msg}</p></div>`;
    }

    // è®°å½•å†å² (å…¨å±€å‡½æ•°)
    window.logHistory = function(bvid) {
        $.ajax({
            url: '/api/log_history',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({bvid: bvid}),
            success: function() { console.log('History logged'); }
        });
    }

    function toggleTodo(bvid) {
        $.ajax({ url: '/api/toggle_todo', type: 'POST', contentType: 'application/json', data: JSON.stringify({bvid: bvid}), success: function() { loadProfile(); } });
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) { $('#preview-avatar').attr('src', e.target.result); }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveProfile() {
        let formData = new FormData();
        formData.append('username', $('#input-username').val());
        formData.append('description', $('#input-desc').val());
        let fileInput = $('#input-avatar')[0];
        if (fileInput.files[0]) formData.append('avatar', fileInput.files[0]);

        $.ajax({
            url: '/api/update_profile', type: 'POST', data: formData, processData: false, contentType: false,
            success: function() {
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                loadProfile();
            }
        });
    }

    function removeAction(bvid, type) {
        if(!confirm("ç¡®å®šç§»é™¤å—?")) return;
        $.ajax({ url: '/api/remove_action', type: 'POST', contentType: 'application/json', data: JSON.stringify({bvid: bvid, type: type}), success: function() { loadProfile(); } });
    }

    $(document).ready(function() {
        loadProfile();
        // æ¿€æ´» Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>

<style>
    .hover-up { transition: transform 0.2s; }
    .hover-up:hover { transform: translateY(-3px); }
    .cursor-pointer { cursor: pointer; }
    .nav-tabs .nav-link { color: #666; }
    .nav-tabs .nav-link.active { color: var(--bili-pink); border-bottom: 2px solid var(--bili-pink); }
</style>
{% endblock %}